learndash.paypal_standard_migration=learndash.paypal_standard_migration||{},((e,a,n,l,t)=>{const i=a.querySelector("#ld-paypal-checkout-sdk-migration-js");let d=!0,r=!1;const o={cardFields:null,nameField:null,numberField:null,expiryField:null,cvvField:null};t.init=()=>{if(i&&void 0!==n&&!r&&(t.cleanupComponents(),r=!0,t.setupCardFields(),i.hasAttribute("data-client-token-expires-in"))){const a=parseInt(i.getAttribute("data-client-token-expires-in"),10)-Math.floor(Date.now()/1e3);a>0&&!e.ldPaypalTimeoutSet&&(e.ldPaypalTimeoutSet=!0,setTimeout((()=>{e.location.replace(e.location.href)}),1e3*a))}},t.cleanupComponents=()=>{try{o.nameField&&(o.nameField.close(),o.nameField=null),o.numberField&&(o.numberField.close(),o.numberField=null),o.expiryField&&(o.expiryField.close(),o.expiryField=null),o.cvvField&&(o.cvvField.close(),o.cvvField=null),o.cardFields&&(o.cardFields.close(),o.cardFields=null)}catch(e){console.warn("PayPal component cleanup warning:",e.message)}},t.showNotice=a=>{e.alert(a)},t.handleGenericError=e=>{if(!d)return void(d=!0);const n=a.querySelector(".ld-paypal-standard__migration-submit");n&&(n.textContent=l.__("Save Payment Method and Continue","learndash"),n.removeAttribute("disabled")),t.showNotice(e)},t.handlePayPalError=e=>{if(e&&e.message&&e.message.includes("destroyed all components"))return console.warn("PayPal components were destroyed, reinitializing..."),t.cleanupComponents(),r=!1,void setTimeout((()=>{r||t.init()}),100);t.handleGenericError(e)},t.createSetupToken=()=>fetch(t.endpoints.setup_token,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":t.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({user_id:t.user_id,is_sandbox:t.is_sandbox})}).then((e=>e.json())).then((e=>e.success?e.data.setup_token.id:(d=!1,t.showNotice(e.message),""))),t.createPaymentToken=a=>fetch(t.endpoints.payment_token,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":t.nonce,"Learndash-Experimental-Rest-Api":"Allow"},body:JSON.stringify({token_id:a.vaultSetupToken,user_id:t.user_id,is_sandbox:t.is_sandbox})}).then((e=>e.json())).then((a=>{if(!a.success)return void t.showNotice(a.message);const n=e.location.href.includes("?")?"&":"?";e.location.href=e.location.href+n+"migration_successful=true"})),t.showCardFieldsNotice=e=>{"p is not a function"===e&&(e="unknown_error");const a={unknown_error:l.__("An invalid card was provided. Please review the card details and try again.","learndash"),ineligible_card_vendor:l.__("The card vendor is not supported.","learndash"),invalid_name:l.__("Please enter a valid card holder name.","learndash"),invalid_number:l.__("Please enter a valid card number.","learndash"),invalid_expiry:l.__("Please enter a valid card expiry date.","learndash"),invalid_cvv:l.__("Please enter a valid card security code.","learndash")},n=e.toLowerCase(),i=a[n];return i?t.showNotice(i):t.showNotice(n)},t.validateBillingAddress=()=>{if(!a.querySelector("#ld-paypal-checkout__billing-address-1").value)return t.showNotice(l.__("Please enter a valid billing address.","learndash")),!1;if(!a.querySelector("#ld-paypal-checkout__billing-postal").value)return t.showNotice(l.__("Please enter a valid postal/zip code.","learndash")),!1;const e=a.querySelector("#ld-paypal-checkout__billing-country");return!(!e.value||""===e.value)||(t.showNotice(l.__("Please select a country.","learndash")),!1)},t.setupCardFields=()=>{const e=a.querySelector(".ld-paypal-standard__migration-submit");if(!e)return;const i={style:{input:{border:"1px solid #bfbfbf","border-radius":"0","font-size":"0.875rem",padding:"10px"},":focus":{"box-shadow":"none",outline:"1px solid #1d1d1d"}},onError:e=>t.handlePayPalError(e),createVaultSetupToken:()=>t.createSetupToken(!0),onApprove:e=>t.createPaymentToken(e)};try{if(o.cardFields=n.CardFields(i),!o.cardFields.isEligible())return void(a.querySelector(".ld-registration-order__checkout-select-item-paypal_checkout_paypal_card").style.display="none");o.nameField=o.cardFields.NameField(),o.numberField=o.cardFields.NumberField(),o.expiryField=o.cardFields.ExpiryField(),o.cvvField=o.cardFields.CVVField(),o.nameField.render("#ld-paypal-checkout__card-name-field"),o.numberField.render("#ld-paypal-checkout__card-number-field"),o.expiryField.render("#ld-paypal-checkout__card-expiry-field"),o.cvvField.render("#ld-paypal-checkout__card-cvv-field"),e.addEventListener("click",(n=>{if(n.preventDefault(),e.classList.contains("saved-card"))t.chargeCard();else{if(e.textContent=l.__("Processing request…","learndash"),e.setAttribute("disabled","disabled"),!t.validateBillingAddress())return e.textContent=l.__("Save Payment Method and Continue","learndash"),void e.removeAttribute("disabled");o.cardFields.submit({billingAddress:{addressLine1:a.querySelector("#ld-paypal-checkout__billing-address-1").value,addressLine2:a.querySelector("#ld-paypal-checkout__billing-address-2").value,adminArea1:a.querySelector("#ld-paypal-checkout__billing-city").value,countryCode:a.querySelector("#ld-paypal-checkout__billing-country").value.toUpperCase(),postalCode:a.querySelector("#ld-paypal-checkout__billing-postal").value}}).then((()=>{e.textContent=l.__("Redirecting…","learndash")})).catch((a=>{e.textContent=l.__("Save Payment Method and Continue","learndash"),e.removeAttribute("disabled"),t.showCardFieldsNotice(a.message)}))}}))}catch(e){t.handlePayPalError(e)}},t.init()})(window,document,window.paypal,window.wp.i18n,learndash.paypal_standard_migration);